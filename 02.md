## 第2课

##### 正确退出程序

有关内存地址，顺序代码执行以及如何正确终止程序的简短课程。

---
## 第2课

#### 正确退出程序

##### 基础知识

在第1课中成功学习如何执行系统调用之后，我们现在需要了解一个内核中最重要的系统调用，sys_exit。

在我们运行的'Hello World!'程序的最后有一个Segmentation fault.那么，计算机程序可以被看作是一条长长的指令，被加载到内存中，并被分成多个段。这个通用的内存池是所有程序共享的，可以用来存储变量、指令、其他程序或其他任何东西。每个分段都有一个地址，以便稍后可以找到存储在该分段中的信息。

To execute a program that is loaded in memory, we use the global label _start: to tell the operating system where in memory our program can be found and executed.  Memory is then accessed sequentially following the program logic which determines the next address to be accessed. The kernel jumps to that address in memory and executes it.

It's important to tell the operating system exactly where it should begin execution and where it should stop. In Lesson 1 we didn't tell the kernel where to stop execution. So, after we called sys_write the program continued sequentially executing the next address in memory, which could have been anything. We don't know what the kernel tried to execute but it caused it to choke and terminate the process for us instead - leaving us the error message of 'Segmentation fault'.  Calling sys_exit at the end of all our programs will mean the kernel knows exactly when to terminate the process and return memory back to the general pool thus avoiding an error.

##### Writing our program

Sys_exit has a simple function definition.  In the Linux System Call Table it is allocated OPCODE 1 and is passed a single argument through EBX.

In order to execute this function all we need to do is:

* Load EBX with 0 to pass zero to the function meaning 'zero errors'.
* Load EAX with 1 to call sys_exit.
* Then request an interrupt on libc using INT 80h.

We then compile, link and run it again.

Note:
Only new code added in each lesson will be commented.

helloworld.asm
```asm
; Hello World Program - asmtutor.com
; Compile with: nasm -f elf helloworld.asm
; Link with (64 bit systems require elf_i386 option): ld -m elf_i386 helloworld.o -o helloworld
; Run with: ./helloworld

SECTION .data
msg     db      'Hello World!', 0Ah

SECTION .text
global  _start

_start:

    mov     edx, 13
    mov     ecx, msg
    mov     ebx, 1
    mov     eax, 4
    int     80h

    mov     ebx, 0      ; return 0 status on exit - 'No Errors'
    mov     eax, 1      ; invoke SYS_EXIT (kernel opcode 1)
    int     80h
```


```
~$ nasm -f elf helloworld.asm
~$ ld -m elf_i386 helloworld.o -o helloworld
~$ ./helloworld
Hello World!
```
